# Automated Unit Test Refactoring
# 自动化单元测试重构

**来源**: FSE 2025 | **作者**: Yi Gao 等

## 摘要
测试异味源于不良设计实践和领域知识不足，会降低测试代码质量并增加维护难度。手动重构测试异味耗时且易出错，而现有基于规则的重构方法在预定义规则未覆盖的场景中表现不佳。本文提出UTRefactor，一个基于上下文增强的LLM框架，用于Java项目的自动测试重构。UTRefactor提取测试代码的相关上下文，利用包含测试异味定义、描述和DSL重构规则的外部知识库，通过链式思维方法模拟手动重构过程，引导LLM逐步消除测试异味。在6个开源Java项目的879个测试上评估，UTRefactor将测试异味从2,375个减少到265个，实现89%的消除率，比直接使用LLM重构提升61.82%。

## 引言核心
- 测试异味源于开发者优先维护生产代码而忽视测试代码，导致测试代码质量下降
- 手动重构耗时低效且易出错，现有自动化工具仅能处理有限类型的测试异味
- LLM在代码理解和生成方面能力突出，但直接使用可能产生幻觉，引入语法或语义错误
- 多种测试异味可能同时存在于单个测试方法中，不同消除顺序可能导致不同结果
- 目前没有工具能高效自动消除所有类型的测试异味

## 方法概述
UTRefactor首先提取项目的测试代码及相关上下文信息（如被测方法和类），然后构建支持测试异味消除的外部知识库，包括测试异味定义与描述、DSL重构规则及其他上下文信息。接着，UTRefactor模拟开发者的手动重构流程：使用链式思维方法引导LLM理解测试意图、识别测试异味，并按照DSL定义的重构步骤逐步重构测试代码。

为解决多异味同时存在的挑战，UTRefactor设计了检查点机制（checkpoint mechanism），确保在单个测试中存在多种异味时能够更彻底地消除。该方法支持多种粒度级别的重构，包括单个测试、测试文件和整个项目。

## 关键实验发现
- RQ1（异味消除效果）：UTRefactor将2,375个测试异味减少到265个，消除率达89%，比直接LLM重构提升61.82%
- RQ2（与规则工具对比）：UTRefactor显著超越现有基于规则的测试异味重构工具的性能
- RQ3（各组件贡献）：上下文增强、DSL规则和检查点机制均对最终效果有正向贡献
- RQ4（重构质量）：重构后的测试代码保持了原有功能和逻辑的正确性

## 写作特征备注
- 标题结构：简洁直接型（直接描述研究任务）
- 摘要是否有数字：是（879、2,375、265、89%、61.82%）
- 是否有RQ：是（通过Challenge形式隐含RQ）
- 是否有Motivating Example：是（Figure 1展示Gson项目中的测试重构示例）
- 贡献点数量：3

## 结论
UTRefactor通过结合上下文信息、DSL重构规则和链式思维方法，有效引导LLM自动消除测试异味，在89%的消除率上显著优于现有方法，为提升测试代码质量提供了实用的自动化工具。
